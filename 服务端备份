#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>
#include <sys/socket.h>
#include <sys/stat.h>
#include <fcntl.h>

#define SERVER_IP "192.168.171.60"
#define SERVER_PORT 10000

// -------------------- å·¥å…·å‡½æ•°ï¼šå‘é€å›ºå®šå­—èŠ‚ --------------------
ssize_t send_all(int sock, const void *buf, size_t len)
{
    size_t total = 0;
    while (total < len)
    {
        ssize_t n = send(sock, (char *)buf + total, len - total, 0);
        if (n <= 0)
            return n;
        total += n;
    }
    return total;
}

// -------------------- å‘é€å›¾ç‰‡å‡½æ•° --------------------
void send_image(int client_fd, const char *filename)
{
    struct stat st;
    if (stat(filename, &st) != 0)
    {
        perror("æ–‡ä»¶ä¸å­˜åœ¨");
        return;
    }

    FILE *fp = fopen(filename, "rb");
    if (!fp)
    {
        perror("æ‰“å¼€æ–‡ä»¶å¤±è´¥");
        return;
    }

    // å‘é€å‘½ä»¤
    char cmd[16] = "IMG_ADD";
    send_all(client_fd, cmd, sizeof(cmd));

    // å‘é€æ–‡ä»¶åï¼ˆå›ºå®šé•¿åº¦ 128ï¼‰
    char basename[128] = {0};
    const char *p = strrchr(filename, '/');
    strcpy(basename, p ? p + 1 : filename);
    send_all(client_fd, basename, sizeof(basename));

    // å‘é€æ–‡ä»¶å¤§å°
    int filesize = st.st_size;
    send_all(client_fd, &filesize, sizeof(filesize));

    // å‘é€æ–‡ä»¶å†…å®¹
    char buf[1024];
    int n;
    int sent = 0;
    while ((n = fread(buf, 1, sizeof(buf), fp)) > 0)
    {
        send_all(client_fd, buf, n);
        sent += n;
    }
    fclose(fp);

    printf("âœ… å·²å‘é€å›¾ç‰‡: %s (%d å­—èŠ‚)\n", basename, sent);
}

// -------------------- åˆ é™¤å›¾ç‰‡å‡½æ•° --------------------
void delete_image(int client_fd, const char *filename)
{
    char cmd[16] = "IMG_DEL";
    send_all(client_fd, cmd, sizeof(cmd));

    int name_len = strlen(filename);
    send_all(client_fd, &name_len, sizeof(name_len));
    send_all(client_fd, filename, name_len);

    printf("ğŸ—‘ï¸ å·²å‘é€åˆ é™¤æŒ‡ä»¤: %s\n", filename);
}

// -------------------- ä¸»ç¨‹åº --------------------
int main()
{
    int server_fd = socket(AF_INET, SOCK_STREAM, 0);
    int opt = 1;
    setsockopt(server_fd, SOL_SOCKET, SO_REUSEADDR, &opt, sizeof(opt));

    struct sockaddr_in server_addr, client_addr;
    socklen_t len = sizeof(client_addr);

    server_addr.sin_family = AF_INET;
    server_addr.sin_port = htons(SERVER_PORT);
    server_addr.sin_addr.s_addr = inet_addr(SERVER_IP);

    if (bind(server_fd, (struct sockaddr *)&server_addr, sizeof(server_addr)) < 0)
    {
        perror("bindå¤±è´¥");
        return -1;
    }

    listen(server_fd, 5);
    printf("ğŸš€ æœåŠ¡å™¨å¯åŠ¨ï¼Œç­‰å¾…å¼€å‘æ¿è¿æ¥...\n");

    int client_fd = accept(server_fd, (struct sockaddr *)&client_addr, &len);
    if (client_fd < 0)
    {
        perror("acceptå¤±è´¥");
        return -1;
    }

    printf("âœ… å¼€å‘æ¿å·²è¿æ¥ï¼š%s\n", inet_ntoa(client_addr.sin_addr));

    // æ“ä½œèœå•
    while (1)
    {
        printf("\n============================\n");
        printf("1. å‘é€å›¾ç‰‡\n");
        printf("2. åˆ é™¤å›¾ç‰‡\n");
        printf("3. é€€å‡ºç¨‹åº\n");
        printf("============================\n");
        printf("è¯·è¾“å…¥æ“ä½œç¼–å·: ");

        int choice;
        scanf("%d", &choice);

        if (choice == 1)
        {
            char path[256];
            printf("è¯·è¾“å…¥è¦å‘é€çš„å›¾ç‰‡è·¯å¾„: ");
            scanf("%s", path);
            send_image(client_fd, path);
        }
        else if (choice == 2)
        {
            char name[128];
            printf("è¯·è¾“å…¥è¦åˆ é™¤çš„å›¾ç‰‡å(ä¸å¸¦è·¯å¾„): ");
            scanf("%s", name);
            delete_image(client_fd, name);
        }
        else if (choice == 3)
        {
            printf("æœåŠ¡å™¨é€€å‡ºã€‚\n");
            break;
        }
        else
        {
            printf("æ— æ•ˆè¾“å…¥ã€‚\n");
        }
    }

    close(client_fd);
    close(server_fd);
    return 0;
}
